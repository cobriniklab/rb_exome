---
title: "Untitled"
author: "Kevin Stachelek"
date: "11/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load required libraries -------------------------------------------------

```{r}

library(tidyr)
library(dplyr)
library(ggplot2)
library(tibble)
library(grid)
library(cowplot)
library(readxl)
library(tidyverse)
library(lubridate)
```

# load required functions -------------------------------------------------

```{r}

plot_cell_lines <- function(exome_curves, cohort, status){
  # browser()
  
  keep_cell_lines <- group_by(exome_curves, cell_line) %>% 
  dplyr::filter(!is.na(no_of_wells)) %>% 
  dplyr::pull(cell_line)
  
  exome_curves <- dplyr::filter(exome_curves, cell_line  %in% keep_cell_lines)
  
  
  my_theme <- theme(
   strip.background = element_rect(
     color="black", fill="transparent", size=1.5, linetype="blank"
     )
   )
  
  breaks = c(1, 10, 100, 300)
  # plot_group <- filter(exome_curves, culture_group == culture_group)
  # plot_group <- plot_group[complete.cases(plot_group),]
  
  plot_group <- dplyr::filter(exome_curves, culture_group == cohort, exome_status == status) %>% 
    group_by(cell_line) %>% 
    # mutate(max = max(no_of_wells, na.rm = TRUE)) %>% 
    # filter(max > 3) %>% 
    identity()
  
  cl_plot <- ggplot(plot_group, aes(x=days_in_culture, y=no_of_wells, color = cell_line)) + 
    geom_line() + 
    scale_y_log10() +
    expand_limits(y = c(1, 300)) +
    theme(text = element_text(size=10), plot.title = element_text(lineheight=.5)) +
    xlab("Days in Culture") +
    ylab("Number of Wells") + 
    geom_text(data = subset(plot_group, !is.na(date_extracted)), aes(label = '*', x = days_in_culture, y = no_of_wells), color="black", size=8, nudge_y = 0.1) +
    theme_cowplot(18) +
    my_theme +
    # xlim(0, 250) +
    scale_x_continuous(breaks = c(0, 100, 200), limits = c(0, 250)) +
    expand_limits(y = c(1, 1000)) + 
    NULL
  
  cl_plot_facet <- cl_plot + 
    facet_wrap(~cell_line, ncol = 4) +
    theme_cowplot(14) + 
    my_theme +
    theme(legend.position="none") +
    NULL
  
  print(cl_plot)
  print(cl_plot_facet) 
  
  plot_path = paste0("~/rb_pipeline/doc/RB_exome_manuscript/", cohort, "_", status, "_plot.png")
  plot_facet_path = paste0("~/rb_pipeline/doc/RB_exome_manuscript/", cohort, "_", status, "_plot_facet.png")
  
  print(paste0("saving plots to: ", plot_path, " and ", plot_facet_path))
  
  save_plot(plot_facet_path, cl_plot_facet, base_height = 6)
  save_plot(plot_path, cl_plot, base_aspect_ratio = 1.5)
  
  return(list(cl_plot, cl_plot_facet))
}
```


# load data ---------------------------------------------------------------
```{r}

# early_gc <- read_excel("~/rb_pipeline/data/rb_cell_line_growth_curves/scorecard_culture_20151101.xlsx", skip = 4) %>% 
#   dplyr::mutate(X__1 = as.numeric(X__1)) %>% 
#   dplyr::mutate(X__1 = as.Date(X__1, origin = "1899-12-30"))

growth_curves_p <- "~/rb_pipeline/data/rb_cell_line_growth_curves/growth_curves_20160125_update_20170825.csv"
growth_curves <- read_csv(growth_curves_p)

keep_cells <- scan("~/rb_pipeline/data/rb_cell_line_growth_curves/exomed_cell_lines.txt", what = character())
keep_cells <- gsub("-.*$", "", keep_cells)
keep_cells <- paste0("RB", keep_cells)

growth_curves <- rownames_to_column(growth_curves, "days_in_culture") %>% 
  gather("cell_line", "no_of_wells", -c(Date, days_in_culture)) %>% 
  mutate(days_in_culture = as.integer(days_in_culture)) %>% 
  mutate(no_of_wells = as.integer(no_of_wells)) %>% 
  mutate(culture_group = ifelse(grepl("VC", cell_line), "CHLA-VC-RB", "CHLA-RB")) %>%
  dplyr::mutate(cell_id = gsub("^.*-", "", cell_line)) %>% 
  dplyr::mutate(exome_status = ifelse((cell_id %in% keep_cells), "exome", "non-exome")) %>% 
  identity()

# cell_line_records <- read_excel(here("data/rb_cell_line_growth_curves/Liquid Nitrogen Freezer Cell Line Storage 081518-dc-ks-ja-lc.xlsx"), sheet=2)

cell_line_records_p <- here::here("data/rb_cell_line_growth_curves/clean_ln_records.csv")
# write_csv(cell_line_records, cell_line_records_p)

cell_line_records <- read_csv(cell_line_records_p) %>% 
  # dplyr::mutate(date_thawed = as.character(as.numeric(date_thawed))) %>% 
  # dplyr::mutate(date_thawed = ymd(date_thawed)) %>%
  identity()

thaw_dates <- unique(cell_line_records[c("cell_line", "date_thawed")]) %>% 
  dplyr::mutate(thawed = ifelse(!is.na(date_thawed), "TRUE", "FALSE")) %>% 
  dplyr::group_by(cell_line) %>% 
  dplyr::slice(which.min(date_thawed))

date_extracted_p <- here::here("data/rb_cell_line_growth_curves/date_dna_extracted.csv")

date_extracted <- read_csv(date_extracted_p)


enucleation_dates <- unique(cell_line_records[c("cell_line", "date_enucleated")])
days_in_culture <- unique(cell_line_records[c("cell_line", "days_in_culture")])

growth_curves <- dplyr::left_join(growth_curves, thaw_dates, by = c("cell_line", "Date" = "date_thawed")) %>% 
  dplyr::left_join(date_extracted, by = "cell_line") %>% 
  dplyr::group_by(cell_line) %>% 
  dplyr::mutate(date_extracted = ifelse(Date!=date_extracted, NA, Date)) %>%
  identity()
```

# export table of days in culture

```{r }
# days_until_extracted <- 
#   growth_curves %>% 
#   dplyr::mutate(date_extracted = as.logical(date_extracted)) %>% 
#   dplyr::filter(!is.na(date_extracted)) %>%
#   dplyr::group_by(cell_line) %>% 
#   identity()
# 
# day_thawed <- 
#   growth_curves %>% 
#   dplyr::group_by(cell_line) %>% 
#   dplyr::slice(which.min(no_of_wells))
# 
# thaw_tbl <- dplyr::bind_rows(days_until_extracted, day_thawed) %>% 
#   dplyr::arrange(cell_line, days_in_culture)

growth_curves <- growth_curves %>% 
  dplyr::mutate(date_extracted = as.logical(date_extracted)) %>%
  identity()
  
growth_curve_dates_path <- fs::path(proj_dir, "doc", "RB_exome_manuscript/stachelek_supplemental/table_s12.csv")

write_csv(growth_curves, growth_curve_dates_path)


```

# plot data ---------------------------------------------------------------

```{r}
vc_plots <- plot_cell_lines(growth_curves, "CHLA-VC-RB", "exome")
```


```{r}
reynolds_plots <- plot_cell_lines(growth_curves, "CHLA-RB", "exome")
```

```{r}
test <- plot_grid(
  vc_plots[[2]], reynolds_plots[[2]],
  labels = "AUTO", ncol = 1,
  rel_heights = c(3,2)
)

ggsave("~/rb_pipeline/doc/RB_exome_manuscript/growth_curves.pdf", test, width = 9, height = 9)

ggsave("~/rb_pipeline/doc/RB_exome_manuscript/stachelek_supplemental/fig_01.pdf")



```

